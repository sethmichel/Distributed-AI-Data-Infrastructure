syntax = "proto3";

package myservice;
option go_package = "./;myservice";

// ============================================
// Message Definitions
// ============================================

// Generic event structure
message Event {
  string entity_id = 1;
  string feature_name = 2;
  double value = 3;
  string timestamp = 4;  // ISO 8601 string for simplicity
}

// File upload messages
message FileChunk {
  bytes content = 1;
  string filename = 2;
}

message UploadStatus {
  bool success = 1;
  string message = 2;
}

// Service B: Model Serving messages
message PredictRequest {
  string entity_id = 1;
  repeated string feature_names = 2;
}

message PredictResponse {
  string entity_id = 1;
  double prediction = 2;
  string model_version = 3;
}

// Python Worker: Transform messages
message TransformRequest {
  repeated Event events = 1;
}

message TransformResponse {
  repeated Event features = 1;
}

// Python Worker: Inference messages
message InferenceRequest {
  string model_name = 1;
  map<string, string> features = 2;
}

message InferenceResponse {
  double prediction = 1;
  string error_message = 2;
}

// Python Worker: Drift messages
message DriftRequest {
  // If empty, analyze all production models. 
  // Can specify specific model_id if needed in future.
  string model_id = 1; 
}

message FeatureDriftMetric {
  string feature_name = 1;
  double ks_stat = 2;
  double ks_p_value = 3;
  double psi = 4;
  double kl_divergence = 5;
  string status = 6; // "PASS", "WARNING", "CRITICAL"
}

message ModelDriftResult {
  string model_id = 1;
  bool drift_detected = 2;
  repeated FeatureDriftMetric feature_metrics = 3;
}

message DriftResponse {
  repeated ModelDriftResult model_results = 1;
}

// Python Worker: Training messages
message TrainRequest {
  string dataset_path = 1;
  string model_type = 2;
}

message TrainResponse {
  bool success = 1;
  string model_id = 2;
  double accuracy = 3;
}

// Service D: Job Scheduler messages
message TriggerJobRequest {
  string job_name = 1;
}

message TriggerJobResponse {
  bool success = 1;
  string job_id = 2;
}

// ============================================
// Service Definitions
// ============================================

// --- Service A: Feature Store ---
service FeatureStore {
  // File upload capability (chunks for large files)
  rpc UploadFile(stream FileChunk) returns (UploadStatus);
}

// --- Service B: Model Serving ---
service ModelServing {
  // Client calls this to get a prediction
  rpc Predict(PredictRequest) returns (PredictResponse);
}

// --- Service D: Job Scheduler ---
service JobScheduler {
  rpc TriggerJob(TriggerJobRequest) returns (TriggerJobResponse);
}

// --- Internal Python Worker Interface ---
// Used by Service A (Transformation) and Service B (Inference)
service PythonWorker {
  // Service A calls this to transform raw data
  rpc TransformFeatures(TransformRequest) returns (TransformResponse);
  // Service B calls this to run inference
  rpc RunInference(InferenceRequest) returns (InferenceResponse);
  // Service C calls this for drift calculation
  rpc CalculateDrift(DriftRequest) returns (DriftResponse);
  // Service D calls this for training
  rpc TrainModel(TrainRequest) returns (TrainResponse);
}
